name: Test Node Download Speed

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *' # 每天 UTC 00:00 运行
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write # 授予写权限

jobs:
  test-node-speed:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Create config directory
        run: mkdir -p config

      - name: Create config.yaml
        run: |
          cat << EOF > config/config.yaml
          sources:
            - name: custom_nodes_from_url
              type: url
              url: https://raw.githubusercontent.com/qjlxg/ss/refs/heads/master/list.meta.yml
          check:
            interval: 3600
            timeout: 20
            concurrency: 2
            speedtest:
              enabled: true
              url: https://speed.cloudflare.com/__down?bytes=5000000
              timeout: 15
              connections: 5
          output:
            path: /output/NodeDownloadSpeedTest.yaml
            format: yaml
          EOF

      - name: Run Proxy-Go for speed test
        run: |
          mkdir -p sc
          rm -f sc/* || true # 清理旧文件
          # 运行 Proxy-Go 容器，挂载配置和输出目录
          # Proxy-Go 的默认命令可能直接启动，或者需要指定 'run'
          # 这里假设它默认读取 /etc/proxy-go/config.yaml 或者通过 -c 参数指定
          # 我们会把它放在 /config/config.yaml，并挂载到 /etc/proxy-go/config.yaml
          docker run --rm --name proxy-go-tester \
            -v $(pwd)/config/config.yaml:/etc/proxy-go/config.yaml:ro \
            -v $(pwd)/sc:/output \
            wangzhe0622/proxy-go:latest # 使用 Proxy-Go 的官方 Docker 镜像

          # 注意：Proxy-Go 默认不是一个长时间运行的服务，它通常会执行完测试就退出。
          # 因此，不需要之前的 `docker logs -f` 和 `until` 循环来等待。
          # 容器退出码会指示成功或失败。
          EXIT_CODE=$(docker inspect -f '{{.State.ExitCode}}' proxy-go-tester)
          echo "Proxy-Go container exited with code: $EXIT_CODE"
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "Proxy-Go exited with an error. Checking logs..."
            docker logs proxy-go-tester
            exit 1
          fi

      - name: Check output file
        run: |
          ls -l sc/ || echo "No files in sc directory"
          cat sc/NodeDownloadSpeedTest.yaml || echo "Output file not found"

      - name: Commit and push results
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add sc/NodeDownloadSpeedTest.yaml
          git commit -m "Update node speed test results" || echo "No changes to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
