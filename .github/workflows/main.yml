name: Aggregate and Filter Clash Nodes # å·¥ä½œæµåç§°

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *' # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTC 0:00, 6:00, 12:00, 18:00ï¼‰

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå·¥ä½œæµå®ä¾‹è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„ Ubuntu è¿è¡Œå™¨ä¸Šæ‰§è¡Œ

    steps:
      - name: Checkout repository # æ­¥éª¤1: æ£€å‡ºæ‚¨çš„ä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: Set up Python # æ­¥éª¤2: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10' # æ˜ç¡®æŒ‡å®š Python 3.10ï¼Œç¡®ä¿ä¸ aiohttp>=3.8.1 å…¼å®¹
          cache: 'pip' # ç¼“å­˜ pip ä¾èµ–ï¼ŒåŠ é€Ÿå®‰è£…

      - name: Verify requirements.txt # æ­¥éª¤3: éªŒè¯ requirements.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        run: |
          if [ ! -f requirements.txt ]; then
            echo "Error: requirements.txt not found"
            exit 1
          fi

      - name: Install dependencies # æ­¥éª¤4: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip # å‡çº§ pip
          pip install -r requirements.txt # å®‰è£… requirements.txt ä¸­åˆ—å‡ºçš„ä¾èµ–
        continue-on-error: false # å¦‚æœå®‰è£…å¤±è´¥ï¼Œåˆ™ç»ˆæ­¢å·¥ä½œæµ

      - name: Initialize log file and directories # æ­¥éª¤5: åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶å’Œç›®å½•
        run: |
          mkdir -p clash_aggregator # ç¡®ä¿ clash_aggregator ç›®å½•å­˜åœ¨
          touch clash_aggregator/clash_aggregator.log # åˆ›å»ºç©ºçš„æ—¥å¿—æ–‡ä»¶
          echo "Initializing log file for Clash Aggregator" > clash_aggregator/clash_aggregator.log # å†™å…¥åˆå§‹ä¿¡æ¯

      - name: Aggregate and Filter Nodes # æ­¥éª¤6: è¿è¡Œæ‚¨çš„èŠ‚ç‚¹èšåˆå’Œè¿‡æ»¤è„šæœ¬
        id: aggregate_nodes # ä¸ºæ­¤æ­¥éª¤åˆ†é…ä¸€ä¸ªID
        run: |
          echo "Starting node aggregation from sources defined in 'clash_aggregator/sources.txt'..."
          # è¿è¡Œ Python è„šæœ¬ï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šè¾“å‡ºæ–‡ä»¶å’Œç«¯å£
          # æ—¥å¿—ä¼šé€šè¿‡ logging æ¨¡å—è¾“å‡ºåˆ° stderr å’Œ clash_aggregator.log
          python ./clash_aggregator/node_aggregator.py \
            --output ./clash_aggregator/config.yaml \
            --port 7890 \
            --socks-port 7891 \
            --log-level INFO # å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼Œä¾‹å¦‚ DEBUG
          echo "Node aggregation finished. Check ./clash_aggregator/config.yaml and ./clash_aggregator/clash_aggregator.log for details."
        env:
          PYTHONUNBUFFERED: 1 # å®æ—¶æ˜¾ç¤º Python è¾“å‡º

      - name: Upload Artifacts # æ­¥éª¤7: ä¸Šä¼ ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ã€æ—¥å¿—å’ŒIPç¼“å­˜
        uses: actions/upload-artifact@v4
        with:
          name: clash-aggregator-artifacts # Artifacts çš„åç§°
          path: |
            clash_aggregator/config.yaml
            clash_aggregator/clash_aggregator.log
            clash_aggregator/ip_cache.json # ç¡®ä¿ ip_cache.json ä¹Ÿè¢«ä¸Šä¼ 
          if-no-files-found: warn # å¦‚æœæ–‡ä»¶ç¼ºå¤±ï¼Œå‘å‡ºè­¦å‘Šä½†ä¸å¤±è´¥

      - name: Commit and Push if changed # æ­¥éª¤8: å¦‚æœç”Ÿæˆçš„é…ç½®æ–‡ä»¶æˆ–æ—¥å¿—æœ‰å˜åŒ–ï¼Œåˆ™æäº¤å¹¶æ¨é€
        run: |
          git config --global user.name 'github-actions[bot]' # é…ç½®Gitç”¨æˆ·åä¸ºGitHub Actionsæœºå™¨äºº
          git config --global user.email 'github-actions[bot]@users.noreply.github.com' # é…ç½®Gitç”¨æˆ·é‚®ç®±
          git add ./clash_aggregator/config.yaml ./clash_aggregator/clash_aggregator.log ./clash_aggregator/ip_cache.json # æ·»åŠ é…ç½®æ–‡ä»¶ã€æ—¥å¿—å’ŒIPç¼“å­˜
          git commit -m "Update Clash config, logs, and IP cache [skip ci]" || echo "No changes to commit" # æäº¤æ›´æ”¹ï¼Œå¹¶ä½¿ç”¨ [skip ci] é˜²æ­¢æœ¬æ¬¡æäº¤å†æ¬¡è§¦å‘å·¥ä½œæµ
          git push # æ¨é€æ›´æ”¹åˆ°ä»“åº“
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ç¡®ä¿å…·æœ‰å†™å…¥æƒé™

      - name: Notify on Failure (Create New Issue) # æ­¥éª¤9: å·¥ä½œæµå¤±è´¥æ—¶åˆ›å»ºæ–°Issue
        if: failure() # åªæœ‰å½“å‰Jobå¤±è´¥æ—¶æ‰è¿è¡Œæ­¤æ­¥éª¤
        uses: actions/github-script@v7
        with:
          script: |
            const workflowRunURL = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const issueTitle = `ğŸ”´ Clash èŠ‚ç‚¹èšåˆå¤±è´¥: ${new Date().toLocaleString()}`;
            const issueBody = `
            Clash èŠ‚ç‚¹èšåˆå·¥ä½œæµè¿è¡Œå¤±è´¥ã€‚è¯·æ£€æŸ¥ä»¥ä¸‹æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯ï¼š
            å·¥ä½œæµè¿è¡Œé“¾æ¥: ${workflowRunURL}

            è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½çš„åŸå› ï¼š
            - è®¢é˜…æºæ˜¯å¦æœ‰æ•ˆï¼Ÿ
            - IP æŸ¥è¯¢ API æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ
            - è„šæœ¬ä¸­æ˜¯å¦æœ‰æ–°çš„è§£æé”™è¯¯ï¼Ÿ
            `;

            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody
              });
              console.log('æˆåŠŸåˆ›å»ºæ–°çš„ Issue é€šçŸ¥å¤±è´¥ã€‚');
            } catch (error) {
              console.error(`åˆ›å»º Issue å¤±è´¥: ${error.message}`);
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ç¡®ä¿æ‹¥æœ‰åˆ›å»ºIssueçš„æƒé™
