name: Clash Speed Test and Sort with starudream/clash-speedtest

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  speed-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Test Network Connectivity
        run: |
          ping -c 4 1.1.1.1 || true
          curl -s -I https://www.cloudflare.com || true

      - name: Download Clash Core (Mihomo)
        id: download_clash_core
        run: |
          MIHOMO_VERSION="1.19.11"
          ARCHIVE_NAME="mihomo-linux-amd64-v${MIHOMO_VERSION}.gz"
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/v${MIHOMO_VERSION}/${ARCHIVE_NAME}"
          EXECUTABLE_SOURCE_NAME="mihomo-linux-amd64-v${MIHOMO_VERSION}"
          EXECUTABLE_NAME="mihomo"

          echo "Downloading Mihomo Core ${ARCHIVE_NAME}..."
          curl -S -L --retry 5 --retry-delay 5 --connect-timeout 10 --max-time 60 --output "$ARCHIVE_NAME" "$MIHOMO_URL" || { echo "Mihomo download failed"; exit 1; }
          echo "Decompressing ${ARCHIVE_NAME}..."
          gzip -d "$ARCHIVE_NAME" || { echo "Mihomo decompression failed"; exit 1; }
          mv "./${EXECUTABLE_SOURCE_NAME}" "./${EXECUTABLE_NAME}" || { echo "Mihomo rename failed"; exit 1; }
          chmod +x "./${EXECUTABLE_NAME}" || { echo "Mihomo chmod failed"; exit 1; }
          echo "Mihomo Core downloaded and prepared."

      - name: Download Full Clash Configuration
        id: download_config
        run: |
          CONFIG_URL="https://raw.githubusercontent.com/qjlxg/vt/refs/heads/main/clash_config.yaml"
          OUTPUT_FILE="clash_config.yaml"
          echo "Downloading Clash configuration from $CONFIG_URL..."
          curl -S -L --retry 5 --retry-delay 5 --connect-timeout 10 --max-time 60 --output "$OUTPUT_FILE" "$CONFIG_URL" || { echo "Config download failed"; exit 1; }
          echo "$OUTPUT_FILE downloaded."
          if [ ! -s "$OUTPUT_FILE" ]; then
            echo "Error: Downloaded config file is empty or missing."
            exit 1
          fi
          if ! grep -q "proxies:" "$OUTPUT_FILE"; then
            echo "Error: No proxies found in clash_config.yaml."
            exit 1
          fi
          echo "Downloaded config content (first 20 lines):"
          head -n 20 "$OUTPUT_FILE" || true

      - name: Start Clash Core (Mihomo)
        id: start_clash_core
        run: |
          echo "Starting Mihomo Core in background..."
          ./mihomo -d . -f clash_config.yaml > mihomo.log 2>&1 &
          MIHOMO_PID=$!
          echo "Mihomo Core started, PID: $MIHOMO_PID"
          sleep 30
          if ! netstat -tuln | grep -q "127.0.0.1:9090"; then
            echo "Error: Mihomo Core did not start on port 9090. Logs:"
            cat mihomo.log || true
            kill $MIHOMO_PID || true
            exit 1
          fi
          PROXY_COUNT=$(curl -s "http://127.0.0.1:9090/proxies" | jq '.proxies | length' || echo 0)
          if [ "$PROXY_COUNT" -eq 0 ]; then
            echo "Error: No proxies loaded by Mihomo. Logs:"
            cat mihomo.log || true
            kill $MIHOMO_PID || true
            exit 1
          fi
          echo "Available proxies:"
          curl -s "http://127.0.0.1:9090/proxies" | jq '.proxies | keys'
          echo "Mihomo Core started with $PROXY_COUNT proxies."
          echo "MIHOMO_PID=$MIHOMO_PID" >> $GITHUB_OUTPUT

      - name: Download clash-speedtest Tool
        id: download_speedtest_tool
        run: |
          SPEEDTEST_VERSION="3.0.1"
          TOOL_ARCHIVE="clash-speedtest_v${SPEEDTEST_VERSION}_linux_amd64.tar.gz"
          TOOL_URL="https://github.com/starudream/clash-speedtest/releases/download/v${SPEEDTEST_VERSION}/${TOOL_ARCHIVE}"
          echo "Downloading clash-speedtest tool..."
          curl -S -L --retry 5 --retry-delay 5 --connect-timeout 10 --max-time 60 --output "$TOOL_ARCHIVE" "$TOOL_URL" || { echo "clash-speedtest download failed"; exit 1; }
          echo "Extracting ${TOOL_ARCHIVE}..."
          tar -xzf "$TOOL_ARCHIVE" || { echo "clash-speedtest extraction failed"; exit 1; }
          mv clash-speedtest clash-speedtest-tool
          chmod +x clash-speedtest-tool || { echo "clash-speedtest chmod failed"; exit 1; }
          echo "clash-speedtest tool downloaded and prepared."

      - name: Run clash-speedtest and Generate Sorted Config
        id: run_speedtest
        if: success() && steps.start_clash_core.outcome == 'success'
        run: |
          MIHOMO_SECRET=""
          echo "Running clash-speedtest tool..."
          ./clash-speedtest-tool \
            --clash-addr "http://127.0.0.1:9090" \
            --clash-secret "${MIHOMO_SECRET}" \
            --output "starudream_sorted.yaml" \
            --download "cloudflare" \
            --threads 5 \
            --size 20
          echo "Speed test completed. Output saved to starudream_sorted.yaml"
          if [ ! -s "starudream_sorted.yaml" ]; then
            echo "Error: starudream_sorted.yaml is empty or not generated."
            exit 1
          fi
          echo "Generated starudream_sorted.yaml (first 50 lines):"
          head -n 50 starudream_sorted.yaml || true

      - name: Validate Generated starudream_sorted.yaml and Count Nodes
        id: count_nodes_api
        if: success() && steps.run_speedtest.outcome == 'success'
        run: |
          if [ -f "starudream_sorted.yaml" ]; then
            echo "'starudream_sorted.yaml' generated, size: $(du -h starudream_sorted.yaml | awk '{print $1}')"
            NODE_COUNT=$(grep -c 'name:' starudream_sorted.yaml || true)
            echo "Detected ${NODE_COUNT} proxy nodes."
            echo "NODE_COUNT=${NODE_COUNT}" >> $GITHUB_OUTPUT
            if [ "${NODE_COUNT}" -eq 0 ]; then
              echo "Warning: No proxy nodes detected in 'starudream_sorted.yaml'."
            fi
          else
            echo "Error: 'starudream_sorted.yaml' was not found."
            echo "NODE_COUNT=0" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Backup Old Clash Config
        if: success() && steps.count_nodes_api.outputs.NODE_COUNT > 0
        run: |
          mkdir -p sc_api
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          echo "Backing up starudream_sorted.yaml to sc_api/starudream_${TIMESTAMP}.yaml..."
          cp starudream_sorted.yaml sc_api/starudream_${TIMESTAMP}.yaml
          echo "Backup complete."

      - name: Commit and Push Sorted Clash Config
        if: success() && steps.count_nodes_api.outputs.NODE_COUNT > 0
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Clash Config: Nodes sorted by latency and speed"
          file_pattern: "starudream_sorted.yaml sc_api/"
          branch: main
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: qjlxg <12179157+qjlxg@users.noreply.github.com>
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Stop Clash Core (Mihomo)
        if: always() && steps.start_clash_core.outcome == 'success' && steps.start_clash_core.outputs.MIHOMO_PID
        run: |
          echo "Stopping Mihomo Core (PID: ${{ steps.start_clash_core.outputs.MIHOMO_PID }})..."
          kill ${{ steps.start_clash_core.outputs.MIHOMO_PID }} || true
          sleep 2
          if ps -p ${{ steps.start_clash_core.outputs.MIHOMO_PID }} > /dev/null; then
            echo "Mihomo Core did not stop gracefully, attempting to force kill."
            kill -9 ${{ steps.start_clash_core.outputs.MIHOMO_PID }} || true
          else
            echo "Mihomo Core stopped successfully."
          fi
