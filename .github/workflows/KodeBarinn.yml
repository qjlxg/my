name: XieCang Speedtest

on:
  workflow_dispatch: # 允许通过 GitHub UI 手动触发工作流
  schedule:
    - cron: '0 */6 * * *' # 每6小时运行一次

jobs:
  run-speedtest:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get latest speedtest-clash release URL
      id: get_release
      run: |
        ASSET_URL=$(curl -s https://api.github.com/repos/xiecang/speedtest-clash/releases/latest | \
          grep "browser_download_url.*speedtest-clash_Linux_x86_64.tar.gz" | \
          awk '{print $2}' | \
          tr -d '"')
        
        if [ -z "$ASSET_URL" ]; then
          echo "Error: Could not find speedtest-clash_Linux_x86_64.tar.gz in latest release assets."
          exit 1
        fi
        
        echo "::set-output name=download_url::$ASSET_URL"
      shell: bash

    - name: Download and extract speedtest-clash
      run: |
        wget ${{ steps.get_release.outputs.download_url }} -O speedtest-clash.tar.gz
        tar -xzf speedtest-clash.tar.gz
        chmod +x speedtest-clash
      working-directory: ${{ runner.temp }}

    - name: Create output directory
      run: mkdir -p sc

    - name: Run speedtest-clash and save output
      run: |
        echo "Starting speedtest-clash..."
        # 运行 speedtest-clash。如果它失败，此步骤将失败。
        ${{ runner.temp }}/speedtest-clash \
          -c https://raw.githubusercontent.com/qjlxg/vt/refs/heads/main/clash_config.yaml \
          -output sc/xiecang.yaml \
          -timeout 20s \ # 再次增加超时时间，给予更多机会
          -size 52428800 \
          -sort b
        
        # 显式检查文件是否存在
        if [ -f "sc/xiecang.yaml" ]; then
          echo "sc/xiecang.yaml was successfully generated."
          # 打印文件前几行以确认内容
          echo "--- Content of sc/xiecang.yaml (first 20 lines) ---"
          head -n 20 sc/xiecang.yaml
          echo "----------------------------------------------------"
        else
          echo "Error: sc/xiecang.yaml was NOT generated. Speedtest-clash might have failed internally."
          # 强制此步骤失败，以便 Git commit 步骤不会执行并报告“文件未找到”
          exit 1
        fi
      shell: bash

    - name: Commit and push results
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add sc/xiecang.yaml
        git commit -m "Update xiecang.yaml with speedtest results" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
