name: Mihomo Node Speed Test

on:
  workflow_dispatch: # åªå…è®¸æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  schedule:
    - cron: '0 */6 * * *' # å¯é€‰ï¼šæ¯ 6 å°æ—¶å®šæ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰

jobs:
  test-and-filter:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Rust ç¼–ç¨‹ç¯å¢ƒ
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: ğŸ“¦ å®‰è£… mihomo-speedtest-rs å·¥å…·
        run: |
          echo "æ­£åœ¨å®‰è£… mihomo-speedtest-rsï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº Rust çš„é«˜æ€§èƒ½ä»£ç†æµ‹è¯•å·¥å…·..."
          cargo install mihomo-speedtest-rs
          echo "mihomo-speedtest-rs å·¥å…·å·²æˆåŠŸå®‰è£…ã€‚"

      - name: â¬‡ï¸ ä¸‹è½½ Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
        id: download_mihomo
        run: |
          echo "æ­£åœ¨æ£€æµ‹ Mihomo æœ€æ–°ç¨³å®šç‰ˆæœ¬..."
          MIHOMO_VERSION=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | grep -Po '"tag_name": "\K[^"]*"' | head -n 1)
          echo "æ£€æµ‹åˆ° Mihomo æœ€æ–°ç‰ˆæœ¬: ${MIHOMO_VERSION}"
          
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          echo "æ­£åœ¨ä» ${MIHOMO_URL} ä¸‹è½½ Mihomo æ ¸å¿ƒ..."
          
          wget -q -O mihomo.gz "${MIHOMO_URL}"
          gunzip mihomo.gz
          chmod +x mihomo
          
          sudo mv mihomo /usr/local/bin/mihomo
          echo "Mihomo æ ¸å¿ƒå·²æˆåŠŸå®‰è£…åˆ° /usr/local/bin/mihomoã€‚"

      - name: â¬‡ï¸ ä¸‹è½½åŸå§‹ Clash è®¢é˜…é…ç½®
        id: download_config
        run: |
          echo "å¼€å§‹ä¸‹è½½åŸå§‹ Clash è®¢é˜…é…ç½®æ–‡ä»¶..."
          curl -sSLo original_clash_config.yaml "https://raw.githubusercontent.com/qjlxg/ss/refs/heads/master/list_raw.txt"
          
          if [ ! -f ./original_clash_config.yaml ] || [ ! -s ./original_clash_config.yaml ]; then
            echo "â—ï¸ é”™è¯¯: original_clash_config.yaml æ–‡ä»¶æœªæˆåŠŸä¸‹è½½æˆ–ä¸ºç©ºã€‚è¯·æ£€æŸ¥è®¢é˜…é“¾æ¥æ˜¯å¦æœ‰æ•ˆã€‚"
            exit 1
          fi
          echo "åŸå§‹ Clash è®¢é˜…é…ç½®ä¸‹è½½å®Œæˆã€‚"
          node_count=$(grep -c '^- name:' original_clash_config.yaml || true) 
          echo "åŸå§‹è®¢é˜…çº¦åŒ…å« ${node_count} ä¸ªèŠ‚ç‚¹ã€‚"

      - name: ğŸš€ è¿è¡Œ mihomo-speedtest-rs è¿›è¡ŒèŠ‚ç‚¹æµ‹è¯•ä¸è¿‡æ»¤
        id: mihomo_test
        run: |
          echo "å¼€å§‹ä½¿ç”¨ mihomo-speedtest-rs è¿›è¡Œç»¼åˆèŠ‚ç‚¹æµ‹è¯•å’Œæ™ºèƒ½è¿‡æ»¤..."
          /usr/local/bin/mihomo-speedtest \
            --config ./original_clash_config.yaml \
            --use-mihomo \
            --mihomo-binary /usr/local/bin/mihomo \
            --max-latency 1000ms \
            --min-download-speed 3 \
            --download-size 5 \
            --upload-size 1 \
            --timeout 60s \
            --max-concurrent 100 \
            --filter "sg|jp|kr|us|ca|de|fr|uk|nl" \
            --block "cn|china|ä¸­å›½|å¤§é™†|åŒ—äº¬|ä¸Šæµ·" \
            --output ./KodeBarinn.yaml \
            --verbose

          if [ ! -f ./KodeBarinn.yaml ] || [ ! -s ./KodeBarinn.yaml ]; then
            echo "â—ï¸ é”™è¯¯: KodeBarinn.yaml æ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©ºã€‚è¿™æ„å‘³ç€æ²¡æœ‰èŠ‚ç‚¹é€šè¿‡æ‰€æœ‰è®¾å®šçš„æµ‹è¯•å’Œè¿‡æ»¤æ¡ä»¶ã€‚"
            exit 1
          fi
          echo "mihomo-speedtest-rs æµ‹è¯•å’Œè¿‡æ»¤å·²å®Œæˆï¼Œåˆæ ¼èŠ‚ç‚¹å·²ä¿å­˜åˆ° KodeBarinn.yamlã€‚"
          final_node_count=$(grep -c '^- name:' KodeBarinn.yaml || true)
          echo "æœ€ç»ˆç”Ÿæˆäº† ${final_node_count} ä¸ªåˆæ ¼èŠ‚ç‚¹ã€‚"

      - name: â¬†ï¸ ä¸Šä¼ åˆæ ¼çš„ Clash é…ç½®åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mihomo-tested-config
          path: KodeBarinn.yaml
          retention-days: 7
          if-no-files-found: ignore
