name: Mihomo Node Speed Test

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  test-and-filter:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ⬇️ 检出仓库代码
        uses: actions/checkout@v4

      - name: 🛠️ 设置 Rust 编程环境
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: ♻️ 缓存 Rust 依赖和编译结果
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('mihomo-speedtest-rs/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: 📦 安装 mihomo-speedtest-rs 工具
        run: |
          echo "正在从 GitHub 仓库编译并安装 mihomo-speedtest-rs..."
          if [ -d "mihomo-speedtest-rs" ]; then
            echo "发现旧的 mihomo-speedtest-rs 目录，正在删除..."
            rm -rf mihomo-speedtest-rs
          fi
          echo "克隆 mihomo-speedtest-rs 仓库..."
          git clone https://github.com/KodeBarinn/mihomo-speedtest-rs.git || { echo "错误：克隆 mihomo-speedtest-rs 仓库失败！"; exit 1; }
          
          cd mihomo-speedtest-rs
          if [ ! -f "Cargo.toml" ]; then
            echo "错误：Cargo.toml 文件不存在，请检查 mihomo-speedtest-rs 仓库！"
            ls -la
            exit 1
          fi
          echo "正在编译 mihomo-speedtest-rs..."
          cargo build --release || { echo "错误：编译 mihomo-speedtest-rs 失败！"; exit 1; }
          
          if [ ! -f "target/release/mihomo-speedtest" ]; then
            echo "错误：mihomo-speedtest 二进制文件未成功编译！"
            exit 1
          fi
          
          sudo mv target/release/mihomo-speedtest /usr/local/bin/mihomo-speedtest
          echo "mihomo-speedtest-rs 工具已成功安装到 /usr/local/bin/mihomo-speedtest。"

      # 以下是其余步骤（保持不变）
      - name: ⬇️ 获取 Mihomo 版本号
        id: download_mihomo_version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "正在检测 Mihomo 最新稳定版本..."
          RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest")
          echo "GitHub API 响应: $RESPONSE"
          
          MIHOMO_VERSION=$(echo "$RESPONSE" | grep -Po '"tag_name": "\K[^"]*"' | head -n 1)
          if [ -z "$MIHOMO_VERSION" ]; then
            echo "错误：无法获取 Mihomo 最新版本号，请检查 GitHub API 或网络连接。"
            exit 1
          fi
          MIHOMO_VERSION=$(echo "$MIHOMO_VERSION" | tr -d '\n\r"')
          echo "version=$MIHOMO_VERSION" >> $GITHUB_ENV
          echo "检测到 Mihomo 最新版本: $MIHOMO_VERSION"

      - name: ♻️ 缓存 Mihomo 核心二进制文件
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/mihomo
          key: ${{ runner.os }}-mihomo-${{ env.version }}
          restore-keys: |
            ${{ runner.os }}-mihomo-

      - name: ⬇️ 下载 Mihomo 核心二进制文件
        run: |
          set -x
          CACHE_HIT="${{ steps.cache-mihomo.outputs.cache-hit }}"
          echo "缓存命中状态: $CACHE_HIT"
          
          if [ "$CACHE_HIT" = "true" ]; then
            echo "Mihomo 核心已从缓存中恢复，跳过下载。"
            if [ -f "/usr/local/bin/mihomo" ]; then
              chmod +x /usr/local/bin/mihomo
              echo "已确保 /usr/local/bin/mihomo 具有执行权限。"
            else
              echo "错误：缓存命中但 Mihomo 核心文件缺失，请检查缓存路径或手动清理缓存。"
              exit 1
            fi
            exit 0
          fi
          
          echo "Mihomo 核心未在缓存中找到，正在下载..."
          MIHOMO_VERSION="${{ env.version }}"
          if [ -z "$MIHOMO_VERSION" ]; then
            echo "错误：无法获取 Mihomo 版本号，请检查上一步骤的输出。"
            exit 1
          fi
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          echo "正在从 ${MIHOMO_URL} 下载 Mihomo 核心..."
          
          wget -q -O mihomo.gz "${MIHOMO_URL}" || { echo "错误：下载 Mihomo 核心失败！请检查 URL 或网络连接。"; exit 1; }
          gunzip mihomo.gz || { echo "错误：解压 Mihomo 核心失败！"; exit 1; }
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/mihomo
          echo "Mihomo 核心已成功安装到 /usr/local/bin/mihomo。"
          set +x

      - name: ⬇️ 下载原始 Clash 订阅配置
        id: download_config
        run: |
          echo "开始下载原始 Clash 订阅配置文件..."
          curl -sSLo original_clash_config.yaml "https://raw.githubusercontent.com/qjlxg/ss/refs/heads/master/list_raw.txt" || { echo "错误：下载订阅文件失败！"; exit 1; }
          
          if [ ! -f ./original_clash_config.yaml ] || [ ! -s ./original_clash_config.yaml ]; then
            echo "错误：original_clash_config.yaml 文件未成功下载或为空，请检查订阅链接。"
            cat original_clash_config.yaml || echo "文件为空或不存在"
            exit 1
          fi
          echo "原始 Clash 订阅配置下载完成。"
          echo "订阅文件内容："
          cat original_clash_config.yaml
          node_count=$(grep -c '^- name:' original_clash_config.yaml || true)
          echo "原始订阅约包含 ${node_count} 个节点。"

      - name: 📁 创建 output 目录
        run: |
          mkdir -p output
          echo "已创建 output/ 目录。"

      - name: 🔍 调试 Mihomo 运行状态
        run: |
          echo "检查 mihomo 核心版本..."
          /usr/local/bin/mihomo --version || { echo "错误：mihomo 核心无法运行！"; exit 1; }
          echo "尝试运行 mihomo 以验证连接..."
          /usr/local/bin/mihomo -f ./original_clash_config.yaml -d . > mihomo.log 2>&1 &
          sleep 5
          echo "mihomo 日志："
          cat mihomo.log
          if ! pgrep mihomo; then
            echo "错误：mihomo 进程未运行！"
            exit 1
          fi
          echo "mihomo 进程正在运行，准备进行节点测试。"

      - name: 🚀 运行 mihomo-speedtest-rs 进行节点测试与过滤
        id: mihomo_test
        run: |
          echo "开始使用 mihomo-speedtest-rs 进行综合节点测试和智能过滤..."
          /usr/local/bin/mihomo-speedtest \
            --config ./original_clash_config.yaml \
            --use-mihomo \
            --mihomo-binary /usr/local/bin/mihomo \
            --max-latency 2000ms \
            --min-download-speed 1 \
            --download-size 5 \
            --upload-size 1 \
            --timeout 60s \
            --max-concurrent 50 \
           # --filter "sg|jp|kr|us|ca|de|fr|uk|nl" \
           # --block "cn|china|中国|大陆|北京|上海" \
            --output ./output/KodeBarinn.yaml \
            --verbose || { echo "错误：mihomo-speedtest-rs 测试失败！"; exit 1; }
          
          if [ ! -f ./output/KodeBarinn.yaml ] || [ ! -s ./output/KodeBarinn.yaml ]; then
            echo "错误：output/KodeBarinn.yaml 文件未生成或为空，可能是没有节点通过测试。"
            cat ./output/KodeBarinn.yaml || echo "文件为空或不存在"
            exit 1
          fi
          echo "mihomo-speedtest-rs 测试和过滤已完成，合格节点已保存到 output/KodeBarinn.yaml。"
          final_node_count=$(grep -c '^- name:' ./output/KodeBarinn.yaml || true)
          echo "最终生成了 ${final_node_count} 个合格节点。"

      - name: ⬆️ 提交结果到仓库
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          echo "提交前检查 KodeBarinn.yaml 内容："
          cat output/KodeBarinn.yaml
          git add output/KodeBarinn.yaml
          git commit -m "Update KodeBarinn.yaml with latest node test results" || { echo "没有新的更改需要提交"; exit 0; }
          git push || { echo "错误：推送更改到仓库失败！"; exit 1; }
