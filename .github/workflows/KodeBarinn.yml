name: Mihomo Node Speed Test

on:
  workflow_dispatch: # å…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */6 * * *' # æ¯ 6 å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼ˆUTC æ—¶é—´ï¼‰

jobs:
  test-and-filter:
    runs-on: ubuntu-latest # ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒ
    timeout-minutes: 360 # è®¾ç½®æœ€å¤§è¿è¡Œæ—¶é—´ä¸º 6 å°æ—¶

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4 # æ£€å‡ºä»“åº“ä»£ç 

      - name: ğŸ› ï¸ è®¾ç½® Rust ç¼–ç¨‹ç¯å¢ƒ
        uses: actions-rs/toolchain@v1 # é…ç½® Rust ç¯å¢ƒ
        with:
          toolchain: stable # ä½¿ç”¨ç¨³å®šç‰ˆ Rust
          profile: minimal # æœ€å°åŒ–å®‰è£…
          override: true # è¦†ç›–é»˜è®¤å·¥å…·é“¾

      - name: â™»ï¸ ç¼“å­˜ Rust ä¾èµ–å’Œç¼–è¯‘ç»“æœ
        uses: actions/cache@v4 # ç¼“å­˜ Rust ç›¸å…³ç›®å½•
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mihomo-speedtest-rs/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
        # æ–°å¢ï¼šå¦‚æœç¼“å­˜å‘½ä¸­ï¼Œä½†ç¼–è¯‘ä»ç„¶å¤±è´¥ï¼Œå¯ä»¥è€ƒè™‘åœ¨æ­¤å¤„æ·»åŠ ä¸€ä¸ª 'on-cache-hit: restore,skip' æˆ–è€…å¼ºåˆ¶é‡å»ºçš„é€»è¾‘
        # ä½†é€šå¸¸å¼ºåˆ¶æ¸…ç†ç›®å½•å’Œç¼“å­˜æ•ˆæœæ›´å¥½

      - name: ğŸ“¦ å®‰è£… mihomo-speedtest-rs å·¥å…·
        run: |
          echo "æ­£åœ¨ä» GitHub ä»“åº“ç¼–è¯‘å¹¶å®‰è£… mihomo-speedtest-rs..."
          # --- å…³é”®ä¿®æ”¹ï¼šå¼ºåˆ¶åˆ é™¤å¹¶é‡æ–°å…‹éš†ä»“åº“ ---
          if [ -d "mihomo-speedtest-rs" ]; then
            echo "å‘ç° mihomo-speedtest-rs ä»“åº“å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤å¹¶é‡æ–°å…‹éš†ä»¥ç¡®ä¿å®Œæ•´æ€§..."
            rm -rf mihomo-speedtest-rs || { echo "é”™è¯¯ï¼šåˆ é™¤ç°æœ‰ mihomo-speedtest-rs ç›®å½•å¤±è´¥ï¼"; exit 1; }
          else
            echo "mihomo-speedtest-rs ä»“åº“ä¸å­˜åœ¨ï¼Œå°†è¿›è¡Œå…‹éš†ã€‚"
          fi
          
          git clone https://github.com/KodeBarinn/mihomo-speedtest-rs.git || { echo "é”™è¯¯ï¼šå…‹éš† mihomo-speedtest-rs ä»“åº“å¤±è´¥ï¼"; exit 1; }
          # --- å…³é”®ä¿®æ”¹ç»“æŸ ---
          
          cd mihomo-speedtest-rs
          cargo build --release || { echo "é”™è¯¯ï¼šç¼–è¯‘ mihomo-speedtest-rs å¤±è´¥ï¼"; exit 1; }
          
          if [ ! -f "target/release/mihomo-speedtest" ]; then
            echo "é”™è¯¯ï¼šmihomo-speedtest äºŒè¿›åˆ¶æ–‡ä»¶æœªæˆåŠŸç¼–è¯‘ï¼"
            exit 1
          fi
          
          sudo mv target/release/mihomo-speedtest /usr/local/bin/mihomo-speedtest
          echo "mihomo-speedtest-rs å·¥å…·å·²æˆåŠŸå®‰è£…åˆ° /usr/local/bin/mihomo-speedtestã€‚"

      - name: â¬‡ï¸ è·å– Mihomo ç‰ˆæœ¬å·
        id: download_mihomo_version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GitHub Token æé«˜ API è¯·æ±‚é…é¢
        run: |
          echo "æ­£åœ¨æ£€æµ‹ Mihomo æœ€æ–°ç¨³å®šç‰ˆæœ¬..."
          # è°ƒè¯•ï¼šæ‰“å° API è¯·æ±‚çš„åŸå§‹å“åº”
          RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest")
          echo "GitHub API å“åº”: $RESPONSE"
          
          MIHOMO_VERSION=$(echo "$RESPONSE" | grep -Po '"tag_name": "\K[^"]*"' | head -n 1)
          if [ -z "$MIHOMO_VERSION" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è·å– Mihomo æœ€æ–°ç‰ˆæœ¬å·ï¼Œè¯·æ£€æŸ¥ GitHub API æˆ–ç½‘ç»œè¿æ¥ã€‚"
            exit 1
          fi
          # æ¸…ç†ç‰ˆæœ¬å·ï¼Œç¡®ä¿ä¸åŒ…å«éæ³•å­—ç¬¦
          MIHOMO_VERSION=$(echo "$MIHOMO_VERSION" | tr -d '\n\r"')
          echo "version=$MIHOMO_VERSION" >> $GITHUB_ENV
          echo "æ£€æµ‹åˆ° Mihomo æœ€æ–°ç‰ˆæœ¬: $MIHOMO_VERSION"

      - name: â™»ï¸ ç¼“å­˜ Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/mihomo
          key: ${{ runner.os }}-mihomo-${{ env.version }}
          restore-keys: |
            ${{ runner.os }}-mihomo-

      - name: â¬‡ï¸ ä¸‹è½½ Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          set -x # å¯ç”¨è°ƒè¯•ï¼Œæ‰“å°æ¯æ¡å‘½ä»¤
          CACHE_HIT="${{ steps.cache-mihomo.outputs.cache-hit }}"
          echo "ç¼“å­˜å‘½ä¸­çŠ¶æ€: $CACHE_HIT"
          
          if [ "$CACHE_HIT" = "true" ]; then
            echo "Mihomo æ ¸å¿ƒå·²ä»ç¼“å­˜ä¸­æ¢å¤ï¼Œè·³è¿‡ä¸‹è½½ã€‚"
            if [ -f "/usr/local/bin/mihomo" ]; then
              chmod +x /usr/local/bin/mihomo
              echo "å·²ç¡®ä¿ /usr/local/bin/mihomo å…·æœ‰æ‰§è¡Œæƒé™ã€‚"
            else
              echo "é”™è¯¯ï¼šç¼“å­˜å‘½ä¸­ä½† Mihomo æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥ç¼“å­˜è·¯å¾„æˆ–æ‰‹åŠ¨æ¸…ç†ç¼“å­˜ã€‚"
              exit 1
            fi
            exit 0
          fi
          
          echo "Mihomo æ ¸å¿ƒæœªåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°ï¼Œæ­£åœ¨ä¸‹è½½..."
          MIHOMO_VERSION="${{ env.version }}"
          if [ -z "$MIHOMO_VERSION" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è·å– Mihomo ç‰ˆæœ¬å·ï¼Œè¯·æ£€æŸ¥ä¸Šä¸€æ­¥éª¤çš„è¾“å‡ºã€‚"
            exit 1
          fi
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          echo "æ­£åœ¨ä» ${MIHOMO_URL} ä¸‹è½½ Mihomo æ ¸å¿ƒ..."
          
          wget -q -O mihomo.gz "${MIHOMO_URL}" || { echo "é”™è¯¯ï¼šä¸‹è½½ Mihomo æ ¸å¿ƒå¤±è´¥ï¼è¯·æ£€æŸ¥ URL æˆ–ç½‘ç»œè¿æ¥ã€‚"; exit 1; }
          gunzip mihomo.gz || { echo "é”™è¯¯ï¼šè§£å‹ Mihomo æ ¸å¿ƒå¤±è´¥ï¼"; exit 1; }
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/mihomo
          echo "Mihomo æ ¸å¿ƒå·²æˆåŠŸå®‰è£…åˆ° /usr/local/bin/mihomoã€‚"
          set +x # å…³é—­è°ƒè¯•

      - name: â¬‡ï¸ ä¸‹è½½åŸå§‹ Clash è®¢é˜…é…ç½®
        id: download_config
        run: |
          echo "å¼€å§‹ä¸‹è½½åŸå§‹ Clash è®¢é˜…é…ç½®æ–‡ä»¶..."
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸‹è½½çš„æ˜¯åŸå§‹çš„txtæ–‡ä»¶
          curl -sSLo raw_nodes.txt "https://raw.githubusercontent.com/qjlxg/ss/refs/heads/master/list_raw.txt" || { echo "é”™è¯¯ï¼šä¸‹è½½è®¢é˜…æ–‡ä»¶å¤±è´¥ï¼"; exit 1; }
          
          if [ ! -f ./raw_nodes.txt ] || [ ! -s ./raw_nodes.txt ]; then
            echo "é”™è¯¯ï¼šraw_nodes.txt æ–‡ä»¶æœªæˆåŠŸä¸‹è½½æˆ–ä¸ºç©ºï¼Œè¯·æ£€æŸ¥è®¢é˜…é“¾æ¥ã€‚"<br>
            exit 1<br>
          fi<br>
          echo "åŸå§‹è®¢é˜…ä¸‹è½½å®Œæˆï¼Œç­‰å¾…è½¬æ¢ã€‚"<br>
          node_count=$(grep -c '^' raw_nodes.txt || true) # ä¼°ç®—è¡Œæ•°ï¼Œä¸ä¸€å®šæ˜¯èŠ‚ç‚¹æ•°
          echo "åŸå§‹è®¢é˜…æ–‡ä»¶çº¦åŒ…å« ${node_count} è¡Œå†…å®¹ã€‚"<br>

      - name: ğŸ”„ å°†åŸå§‹è®¢é˜…è½¬æ¢ä¸º Clash YAML (é€šè¿‡ Base64 è§£ç )
        id: convert_to_clash_yaml
        run: |
          echo "å¼€å§‹å°è¯•å°†åŸå§‹è®¢é˜…æ–‡ä»¶è§£ç å¹¶è½¬æ¢ä¸º Clash YAML æ ¼å¼..."
          # å°è¯•è§£ç åŸå§‹æ–‡ä»¶å†…å®¹ï¼Œçœ‹æ˜¯å¦æ˜¯æœ‰æ•ˆçš„YAML
          if base64 -d raw_nodes.txt 2>/dev/null | grep -q "proxies:"; then
            echo "åŸå§‹æ–‡ä»¶ä¼¼ä¹æ˜¯ Base64 ç¼–ç çš„ Clash YAMLï¼Œæ­£åœ¨è§£ç ..."
            base64 -d raw_nodes.txt > original_clash_config.yaml
            if [ ! -f ./original_clash_config.yaml ] || [ ! -s ./original_clash_config.yaml ]; then
              echo "é”™è¯¯ï¼šBase64 è§£ç å original_clash_config.yaml æ–‡ä»¶ä¸ºç©ºã€‚"<br>
              exit 1<br>
            fi<br>
            echo "Base64 è§£ç å¹¶è½¬æ¢ä¸º original_clash_config.yaml æˆåŠŸã€‚"<br>
            converted_node_count=$(grep -c '^- name:' original_clash_config.yaml || true)<br>
            echo "è½¬æ¢åçº¦åŒ…å« ${converted_node_count} ä¸ªèŠ‚ç‚¹ã€‚"<br>
          else
            echo "åŸå§‹æ–‡ä»¶ä¼¼ä¹ä¸æ˜¯ Base64 ç¼–ç çš„ Clash YAMLï¼Œè·³è¿‡ç›´æ¥è§£ç ã€‚"
            echo "æ­¤å·¥ä½œæµéœ€è¦åŸå§‹è®¢é˜…æ˜¯ Clash YAML æ ¼å¼æˆ– Base64 ç¼–ç çš„ Clash YAMLã€‚"
            echo "å¦‚æœæ‚¨ç¡®å®šåŸå§‹è®¢é˜…æ˜¯å…¶ä»–æ ¼å¼ï¼ˆå¦‚ç›´é“¾åˆ—è¡¨ï¼‰ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ª Subconverter æ­¥éª¤ã€‚"
            # ä¸ºäº†è®©å·¥ä½œæµèƒ½å¤Ÿç»§ç»­ï¼Œæˆ‘ä»¬ä»ç„¶å¤åˆ¶åŸå§‹æ–‡ä»¶ï¼Œä½†åç»­æ­¥éª¤å¾ˆå¯èƒ½ä¼šå¤±è´¥
            cp raw_nodes.txt original_clash_config.yaml
            echo "è­¦å‘Šï¼šraw_nodes.txt ç›´æ¥å¤åˆ¶ä¸º original_clash_config.yamlï¼Œè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦å…¼å®¹ mihomo-speedtest-rsã€‚"
            exit 1 # æ˜ç¡®æŒ‡ç¤ºå¯èƒ½æ— æ³•å¤„ç†ï¼Œå¹¶ä¸­æ–­ä»¥å¼•èµ·æ³¨æ„
          fi

      - name: ğŸ“ åˆ›å»º output ç›®å½•
        run: |
          mkdir -p output
          echo "å·²åˆ›å»º output/ ç›®å½•ã€‚"

      - name: ğŸš€ è¿è¡Œ mihomo-speedtest-rs è¿›è¡ŒèŠ‚ç‚¹æµ‹è¯•ä¸è¿‡æ»¤
        id: mihomo_test
        run: |
          echo "å¼€å§‹ä½¿ç”¨ mihomo-speedtest-rs è¿›è¡Œç»¼åˆèŠ‚ç‚¹æµ‹è¯•å’Œæ™ºèƒ½è¿‡æ»¤..."
          /usr/local/bin/mihomo-speedtest \
            --config ./original_clash_config.yaml \ # æ³¨æ„è¿™é‡Œç°åœ¨æ˜¯è½¬æ¢åçš„æ–‡ä»¶
            --use-mihomo \
            --mihomo-binary /usr/local/bin/mihomo \
            --max-latency 1000ms \
            --min-download-speed 3 \
            --download-size 5 \
            --upload-size 1 \
            --timeout 60s \
            --max-concurrent 100 \
            --filter "sg|jp|kr|us|ca|de|fr|uk|nl" \
            --block "cn|china|ä¸­å›½|å¤§é™†|åŒ—äº¬|ä¸Šæµ·" \
            --output ./output/KodeBarinn.yaml \
            --verbose || { echo "é”™è¯¯ï¼šmihomo-speedtest-rs æµ‹è¯•å¤±è´¥ï¼"; exit 1; }
          
          if [ ! -f ./output/KodeBarinn.yaml ] || [ ! -s ./output/KodeBarinn.yaml ]; then
            echo "é”™è¯¯ï¼šoutput/KodeBarinn.yaml æ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©ºï¼Œå¯èƒ½æ˜¯æ²¡æœ‰èŠ‚ç‚¹é€šè¿‡æµ‹è¯•ã€‚"<br>
            exit 1<br>
          fi<br>
          echo "mihomo-speedtest-rs æµ‹è¯•å’Œè¿‡æ»¤å·²å®Œæˆï¼Œåˆæ ¼èŠ‚ç‚¹å·²ä¿å­˜åˆ° output/KodeBarinn.yamlã€‚"<br>
          final_node_count=$(grep -c '^- name:' ./output/KodeBarinn.yaml || true)<br>
          echo "æœ€ç»ˆç”Ÿæˆäº† ${final_node_count} ä¸ªåˆæ ¼èŠ‚ç‚¹ã€‚"<br>

      - name: â¬†ï¸ æäº¤ç»“æœåˆ°ä»“åº“
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add output/KodeBarinn.yaml
          git commit -m "Update KodeBarinn.yaml with latest node test results" || { echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"; exit 0; }
          git push || { echo "é”™è¯¯ï¼šæ¨é€æ›´æ”¹åˆ°ä»“åº“å¤±è´¥ï¼"; exit 1; }
