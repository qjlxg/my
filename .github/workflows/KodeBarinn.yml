name: Mihomo Node Speed Test

on:
  workflow_dispatch: # å…è®¸æ‚¨åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  schedule:
    - cron: '0 */6 * * *' # å¯é€‰ï¼šæ¯ 6 å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰

jobs:
  test-and-filter:
    runs-on: ubuntu-latest # åœ¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒä¸­è¿è¡Œ
    timeout-minutes: 360 # è®¾ç½®å·¥ä½œæµæœ€å¤§è¿è¡Œæ—¶é—´ä¸º 360 åˆ†é’Ÿ (6å°æ—¶)

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4 # æ£€å‡ºæ‚¨çš„ GitHub ä»“åº“ä»£ç 

      - name: ğŸ› ï¸ è®¾ç½® Rust ç¼–ç¨‹ç¯å¢ƒ
        uses: actions-rs/toolchain@v1 # ä½¿ç”¨ actions-rs/toolchain é…ç½® Rust ç¯å¢ƒ
        with:
          toolchain: stable # å®‰è£…ç¨³å®šç‰ˆ Rust
          profile: minimal # æœ€å°åŒ–å®‰è£…ï¼ŒèŠ‚çœç©ºé—´å’Œæ—¶é—´
          override: true # è¦†ç›–é»˜è®¤å·¥å…·é“¾è®¾ç½®

      - name: â™»ï¸ ç¼“å­˜ Rust ä¾èµ–å’Œç¼–è¯‘ç»“æœ
        uses: actions/cache@v4 # ä½¿ç”¨ actions/cache æ¥ç¼“å­˜ Rust ç›¸å…³çš„ç›®å½•
        with:
          path: |
            ~/.cargo/registry # ç¼“å­˜ Rust crates æ³¨å†Œè¡¨
            ~/.cargo/git      # ç¼“å­˜ Git ä¾èµ–
            mihomo-speedtest-rs/target # ç¼“å­˜ mihomo-speedtest-rs çš„ç¼–è¯‘äº§ç‰©
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }} # ç¼“å­˜é”®ï¼ŒåŸºäºæ“ä½œç³»ç»Ÿå’Œ Cargo.lock æ–‡ä»¶å†…å®¹
          restore-keys: |
            ${{ runner.os }}-cargo- # æ¢å¤é”®ï¼Œç”¨äºéƒ¨åˆ†åŒ¹é…ç¼“å­˜

      - name: ğŸ“¦ å®‰è£… mihomo-speedtest-rs å·¥å…·
        run: |
          echo "æ­£åœ¨ä» GitHub ä»“åº“ç¼–è¯‘å¹¶å®‰è£… mihomo-speedtest-rs..."
          # æ£€æŸ¥ mihomo-speedtest-rs ä»“åº“æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¯èƒ½ä»ç¼“å­˜ä¸­æ¢å¤ï¼‰
          if [ ! -d "mihomo-speedtest-rs" ]; then
            git clone https://github.com/KodeBarinn/mihomo-speedtest-rs.git
          else
            echo "mihomo-speedtest-rs ä»“åº“å·²å­˜åœ¨ï¼Œè·³è¿‡å…‹éš†ã€‚"
          fi
          
          cd mihomo-speedtest-rs # è¿›å…¥é¡¹ç›®ç›®å½•
          cargo build --release # ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬ï¼Œä¼˜åŒ–æ€§èƒ½
          
          # æ£€æŸ¥ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "target/release/mihomo-speedtest" ]; then
            echo "é”™è¯¯ï¼šmihomo-speedtest äºŒè¿›åˆ¶æ–‡ä»¶æœªæˆåŠŸç¼–è¯‘ï¼"
            exit 1
          fi

          # å°†ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ç§»åŠ¨åˆ° /usr/local/binï¼Œä½¿å…¶å¯åœ¨ PATH ä¸­ç›´æ¥è°ƒç”¨
          sudo mv target/release/mihomo-speedtest /usr/local/bin/mihomo-speedtest
          echo "mihomo-speedtest-rs å·¥å…·å·²æˆåŠŸå®‰è£…åˆ° /usr/local/bin/mihomo-speedtestã€‚"

      - name: â¬‡ï¸ è·å– Mihomo ç‰ˆæœ¬å·
        id: download_mihomo_version # ä¸ºæ­¤æ­¥éª¤è®¾ç½® IDï¼Œä»¥ä¾¿åç»­æ­¥éª¤å¼•ç”¨å…¶è¾“å‡º
        run: |
          echo "æ­£åœ¨æ£€æµ‹ Mihomo æœ€æ–°ç¨³å®šç‰ˆæœ¬..."
          # ä½¿ç”¨ GitHub API è·å–æœ€æ–°ç‰ˆæœ¬å·
          MIHOMO_VERSION=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | grep -Po '"tag_name": "\K[^"]*"' | head -n 1)
          # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºæ­¤æ­¥éª¤çš„è¾“å‡ºï¼Œä¾›ç¼“å­˜æ­¥éª¤ä½¿ç”¨
          echo "version=${MIHOMO_VERSION}" >> $GITHUB_OUTPUT 
          echo "æ£€æµ‹åˆ° Mihomo æœ€æ–°ç‰ˆæœ¬: ${MIHOMO_VERSION}"

      - name: â™»ï¸ ç¼“å­˜ Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
        id: cache-mihomo # ä¸ºæ­¤ç¼“å­˜æ­¥éª¤è®¾ç½® ID
        uses: actions/cache@v4 # ä½¿ç”¨ actions/cache
        with:
          path: /usr/local/bin/mihomo # Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„
          # ç¼“å­˜é”®ï¼ŒåŸºäºæ“ä½œç³»ç»Ÿå’Œä¸Šä¸€æ­¥è·å–çš„ Mihomo ç‰ˆæœ¬å·
          key: ${{ runner.os }}-mihomo-${{ steps.download_mihomo_version.outputs.version }} 
          restore-keys: |
            ${{ runner.os }}-mihomo- # æ¢å¤é”®

      - name: â¬‡ï¸ ä¸‹è½½ Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
        run: |
          # æ£€æŸ¥ç¼“å­˜æ˜¯å¦å‘½ä¸­ã€‚å¦‚æœå‘½ä¸­ï¼Œè¡¨ç¤º Mihomo æ ¸å¿ƒå·²æ¢å¤ï¼Œè·³è¿‡ä¸‹è½½
          if [ "${{ steps.cache-mihomo.outputs.cache-hit }}" = "true" ]; then
            echo "Mihomo æ ¸å¿ƒå·²ä»ç¼“å­˜ä¸­æ¢å¤ï¼Œè·³è¿‡ä¸‹è½½ã€‚"
            # ç¡®ä¿æ¢å¤çš„äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
            if [ -f "/usr/local/bin/mihomo" ]; then
              chmod +x /usr/local/bin/mihomo
              echo "å·²ç¡®ä¿ /usr/local/bin/mihomo å…·æœ‰æ‰§è¡Œæƒé™ã€‚"
            else
              echo "é”™è¯¯ï¼šç¼“å­˜å‘½ä¸­ä½† Mihomo æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥ç¼“å­˜è·¯å¾„æˆ–æ‰‹åŠ¨æ¸…ç†ç¼“å­˜ã€‚"
            fi
            exit 0 # ç¼“å­˜å‘½ä¸­ï¼ŒæˆåŠŸé€€å‡ºæ­¤æ­¥éª¤
          fi
          
          # ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œä¸‹è½½é€»è¾‘
          echo "Mihomo æ ¸å¿ƒæœªåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°ï¼Œæ­£åœ¨ä¸‹è½½..."
          MIHOMO_VERSION="${{ steps.download_mihomo_version.outputs.version }}" # è·å–ä¹‹å‰æ­¥éª¤çš„ç‰ˆæœ¬å·
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          echo "æ­£åœ¨ä» ${MIHOMO_URL} ä¸‹è½½ Mihomo æ ¸å¿ƒ..."
          
          wget -q -O mihomo.gz "${MIHOMO_URL}" # ä¸‹è½½ Mihomo å‹ç¼©åŒ…
          gunzip mihomo.gz # è§£å‹
          chmod +x mihomo # æ·»åŠ æ‰§è¡Œæƒé™
          
          sudo mv mihomo /usr/local/bin/mihomo # ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
          echo "Mihomo æ ¸å¿ƒå·²æˆåŠŸå®‰è£…åˆ° /usr/local/bin/mihomoã€‚"

      - name: â¬‡ï¸ ä¸‹è½½åŸå§‹ Clash è®¢é˜…é…ç½®
        id: download_config
        run: |
          echo "å¼€å§‹ä¸‹è½½åŸå§‹ Clash è®¢é˜…é…ç½®æ–‡ä»¶..."
          # ä»æŒ‡å®š URL ä¸‹è½½è®¢é˜…æ–‡ä»¶
          curl -sSLo original_clash_config.yaml "https://raw.githubusercontent.com/qjlxg/ss/refs/heads/master/list_raw.txt"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸä¸‹è½½ä¸”ä¸ä¸ºç©º
          if [ ! -f ./original_clash_config.yaml ] || [ ! -s ./original_clash_config.yaml ]; then
            echo "â—ï¸ é”™è¯¯: original_clash_config.yaml æ–‡ä»¶æœªæˆåŠŸä¸‹è½½æˆ–ä¸ºç©ºã€‚è¯·æ£€æŸ¥è®¢é˜…é“¾æ¥æ˜¯å¦æœ‰æ•ˆã€‚"
            exit 1
          fi
          echo "åŸå§‹ Clash è®¢é˜…é…ç½®ä¸‹è½½å®Œæˆã€‚"
          # ç»Ÿè®¡èŠ‚ç‚¹æ•°é‡
          node_count=$(grep -c '^- name:' original_clash_config.yaml || true) 
          echo "åŸå§‹è®¢é˜…çº¦åŒ…å« ${node_count} ä¸ªèŠ‚ç‚¹ã€‚"

      - name: ğŸš€ è¿è¡Œ mihomo-speedtest-rs è¿›è¡ŒèŠ‚ç‚¹æµ‹è¯•ä¸è¿‡æ»¤
        id: mihomo_test
        run: |
          echo "å¼€å§‹ä½¿ç”¨ mihomo-speedtest-rs è¿›è¡Œç»¼åˆèŠ‚ç‚¹æµ‹è¯•å’Œæ™ºèƒ½è¿‡æ»¤..."
          # æ‰§è¡Œ mihomo-speedtest å‘½ä»¤ï¼Œä¼ å…¥å„é¡¹å‚æ•°
          /usr/local/bin/mihomo-speedtest \
            --config ./original_clash_config.yaml \
            --use-mihomo \
            --mihomo-binary /usr/local/bin/mihomo \
            --max-latency 1000ms \
            --min-download-speed 3 \
            --download-size 5 \
            --upload-size 1 \
            --timeout 60s \
            --max-concurrent 100 \
            --filter "sg|jp|kr|us|ca|de|fr|uk|nl" \
            --block "cn|china|ä¸­å›½|å¤§é™†|åŒ—äº¬|ä¸Šæµ·" \
            --output ./KodeBarinn.yaml \
            --verbose

          # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦æˆåŠŸç”Ÿæˆä¸”ä¸ä¸ºç©º
          if [ ! -f ./KodeBarinn.yaml ] || [ ! -s ./KodeBarinn.yaml ]; then
            echo "â—ï¸ é”™è¯¯: KodeBarinn.yaml æ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©ºã€‚è¿™æ„å‘³ç€æ²¡æœ‰èŠ‚ç‚¹é€šè¿‡æ‰€æœ‰è®¾å®šçš„æµ‹è¯•å’Œè¿‡æ»¤æ¡ä»¶ã€‚"
            exit 1
          fi
          echo "mihomo-speedtest-rs æµ‹è¯•å’Œè¿‡æ»¤å·²å®Œæˆï¼Œåˆæ ¼èŠ‚ç‚¹å·²ä¿å­˜åˆ° KodeBarinn.yamlã€‚"
          # ç»Ÿè®¡æœ€ç»ˆåˆæ ¼èŠ‚ç‚¹æ•°é‡
          final_node_count=$(grep -c '^- name:' KodeBarinn.yaml || true)
          echo "æœ€ç»ˆç”Ÿæˆäº† ${final_node_count} ä¸ªåˆæ ¼èŠ‚ç‚¹ã€‚"

      - name: â¬†ï¸ ä¸Šä¼ åˆæ ¼çš„ Clash é…ç½®åˆ° Artifacts
        uses: actions/upload-artifact@v4 # ä½¿ç”¨ actions/upload-artifact ä¸Šä¼ ç”Ÿæˆçš„æ–‡ä»¶
        with:
          name: mihomo-tested-config # Artifact åç§°
          path: KodeBarinn.yaml # è¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
          retention-days: 7 # Artifact ä¿ç•™å¤©æ•°
          if-no-files-found: ignore # å¦‚æœæ–‡ä»¶æœªæ‰¾åˆ°åˆ™å¿½ç•¥é”™è¯¯
