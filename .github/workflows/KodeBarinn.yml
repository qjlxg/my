name: Mihomo Node Speed Test

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  test-and-filter:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Rust ç¼–ç¨‹ç¯å¢ƒ
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: â™»ï¸ ç¼“å­˜ Rust ä¾èµ–å’Œç¼–è¯‘ç»“æœ
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            mihomo-speedtest-rs/target # ç¼“å­˜ç¼–è¯‘åçš„ç›®æ ‡æ–‡ä»¶
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }} # ä½¿ç”¨ Cargo.lock æ–‡ä»¶ä½œä¸ºç¼“å­˜é”®
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ“¦ å®‰è£… mihomo-speedtest-rs å·¥å…·
        run: |
          echo "æ­£åœ¨ä» GitHub ä»“åº“ç¼–è¯‘å¹¶å®‰è£… mihomo-speedtest-rs..."
          # å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å…‹éš†ä»“åº“ï¼›å¦‚æœç¼“å­˜å‘½ä¸­ï¼Œé¡¹ç›®å¯èƒ½å·²ç»å­˜åœ¨
          if [ ! -d "mihomo-speedtest-rs" ]; then
            git clone https://github.com/KodeBarinn/mihomo-speedtest-rs.git
          else
            echo "mihomo-speedtest-rs ä»“åº“å·²å­˜åœ¨ï¼Œè·³è¿‡å…‹éš†ã€‚"
          fi
          
          cd mihomo-speedtest-rs
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æäº¤ï¼Œå¦‚æœæœ‰ï¼Œå°è¯•æ‹‰å–æ›´æ–°
          # æ³¨æ„ï¼šæ­¤æ­¥ä»…åœ¨å·²å…‹éš†ä»“åº“å­˜åœ¨ä¸”æœªè¢«åˆ é™¤æ—¶æœ‰æ•ˆ
          # å¦‚æœæ‚¨çš„ .github/workflows/ ç›®å½•ä¸ mihomo-speedtest-rs ä»“åº“æ˜¯åŒä¸€ä¸ªï¼Œ
          # ä¸”æ‚¨ç›´æ¥ç¼–è¾‘è¯¥æ–‡ä»¶ï¼Œé‚£ä¹ˆå®ƒä¼šè¢« checkout è¦†ç›–
          # å®é™…åº”ç”¨ä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨å•ç‹¬çš„ step æ¥å¤„ç†æºç çš„æ›´æ–°æˆ–ç¡®ä¿ fresh clone
          # å¯¹äºè¿™ä¸ªåœºæ™¯ï¼Œç›´æ¥ä¾èµ–ç¼“å­˜å’Œ build --release å³å¯
          
          cargo build --release # ç¼–è¯‘å‘å¸ƒç‰ˆæœ¬ï¼Œæ€§èƒ½æ›´ä¼˜
          
          # ç¡®ä¿ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶å­˜åœ¨
          if [ ! -f "target/release/mihomo-speedtest" ]; then
            echo "é”™è¯¯ï¼šmihomo-speedtest äºŒè¿›åˆ¶æ–‡ä»¶æœªæˆåŠŸç¼–è¯‘ï¼"
            exit 1
          fi

          # å°†ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ç§»åŠ¨åˆ° /usr/local/binï¼Œä½¿å…¶å¯åœ¨ PATH ä¸­ç›´æ¥è°ƒç”¨
          sudo mv target/release/mihomo-speedtest /usr/local/bin/mihomo-speedtest
          echo "mihomo-speedtest-rs å·¥å…·å·²æˆåŠŸå®‰è£…åˆ° /usr/local/bin/mihomo-speedtestã€‚"

      - name: â™»ï¸ ç¼“å­˜ Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
        id: cache-mihomo
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/mihomo # Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„
          key: ${{ runner.os }}-mihomo-${{ steps.download_mihomo_version.outputs.version }} # ä½¿ç”¨ç³»ç»Ÿå’Œ Mihomo ç‰ˆæœ¬å·ä½œä¸ºç¼“å­˜é”®

      - name: â¬‡ï¸ ä¸‹è½½ Mihomo æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶
        id: download_mihomo_version # æ­¤æ­¥éª¤ç”¨äºè·å– Mihomo ç‰ˆæœ¬å¹¶è®¾ç½®è¾“å‡º
        run: |
          echo "æ­£åœ¨æ£€æµ‹ Mihomo æœ€æ–°ç¨³å®šç‰ˆæœ¬..."
          MIHOMO_VERSION=$(curl -s "https://api.github.com/repos/MetaCubeX/mihomo/releases/latest" | grep -Po '"tag_name": "\K[^"]*"' | head -n 1)
          echo "MIHOMO_VERSION=${MIHOMO_VERSION}" >> $GITHUB_OUTPUT # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºè¾“å‡ºï¼Œä¾›ç¼“å­˜æ­¥éª¤ä½¿ç”¨
          echo "æ£€æµ‹åˆ° Mihomo æœ€æ–°ç‰ˆæœ¬: ${MIHOMO_VERSION}"
          
          # æ£€æŸ¥ç¼“å­˜æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœå‘½ä¸­åˆ™è·³è¿‡ä¸‹è½½
          if [[ "${{ steps.cache-mihomo.outputs.cache-hit }}" == "true" ]]; then
            echo "Mihomo æ ¸å¿ƒå·²ä»ç¼“å­˜ä¸­æ¢å¤ï¼Œè·³è¿‡ä¸‹è½½ã€‚"
            # ç¡®ä¿æ¢å¤çš„äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
            if [ -f "/usr/local/bin/mihomo" ]; then
              chmod +x /usr/local/bin/mihomo
              echo "å·²ç¡®ä¿ /usr/local/bin/mihomo å…·æœ‰æ‰§è¡Œæƒé™ã€‚"
            else
              echo "é”™è¯¯ï¼šç¼“å­˜ä¸­æœªæ‰¾åˆ° Mihomo æ ¸å¿ƒæ–‡ä»¶ï¼Œå°è¯•é‡æ–°ä¸‹è½½ã€‚"
              # å¦‚æœç¼“å­˜å‘½ä¸­ä½†æ–‡ä»¶ç¼ºå¤±ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä¸‹è½½é€»è¾‘
              # (é€šå¸¸ç¼“å­˜ä¼šç¡®ä¿æ–‡ä»¶å­˜åœ¨ï¼Œä½†ä»¥é˜²ä¸‡ä¸€)
            fi
            exit 0 # ç¼“å­˜å‘½ä¸­ï¼Œé€€å‡ºæ­¤æ­¥éª¤
          fi
          
          echo "Mihomo æ ¸å¿ƒæœªåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°ï¼Œæ­£åœ¨ä¸‹è½½..."
          MIHOMO_URL="https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          echo "æ­£åœ¨ä» ${MIHOMO_URL} ä¸‹è½½ Mihomo æ ¸å¿ƒ..."
          
          wget -q -O mihomo.gz "${MIHOMO_URL}"
          gunzip mihomo.gz
          chmod +x mihomo
          
          sudo mv mihomo /usr/local/bin/mihomo
          echo "Mihomo æ ¸å¿ƒå·²æˆåŠŸå®‰è£…åˆ° /usr/local/bin/mihomoã€‚"

      - name: â¬‡ï¸ ä¸‹è½½åŸå§‹ Clash è®¢é˜…é…ç½®
        id: download_config
        run: |
          echo "å¼€å§‹ä¸‹è½½åŸå§‹ Clash è®¢é˜…é…ç½®æ–‡ä»¶..."
          curl -sSLo original_clash_config.yaml "https://raw.githubusercontent.com/qjlxg/ss/refs/heads/master/list_raw.txt"
          
          if [ ! -f ./original_clash_config.yaml ] || [ ! -s ./original_clash_config.yaml ]; then
            echo "â—ï¸ é”™è¯¯: original_clash_config.yaml æ–‡ä»¶æœªæˆåŠŸä¸‹è½½æˆ–ä¸ºç©ºã€‚è¯·æ£€æŸ¥è®¢é˜…é“¾æ¥æ˜¯å¦æœ‰æ•ˆã€‚"
            exit 1
          fi
          echo "åŸå§‹ Clash è®¢é˜…é…ç½®ä¸‹è½½å®Œæˆã€‚"
          node_count=$(grep -c '^- name:' original_clash_config.yaml || true) 
          echo "åŸå§‹è®¢é˜…çº¦åŒ…å« ${node_count} ä¸ªèŠ‚ç‚¹ã€‚"

      - name: ğŸš€ è¿è¡Œ mihomo-speedtest-rs è¿›è¡ŒèŠ‚ç‚¹æµ‹è¯•ä¸è¿‡æ»¤
        id: mihomo_test
        run: |
          echo "å¼€å§‹ä½¿ç”¨ mihomo-speedtest-rs è¿›è¡Œç»¼åˆèŠ‚ç‚¹æµ‹è¯•å’Œæ™ºèƒ½è¿‡æ»¤..."
          /usr/local/bin/mihomo-speedtest \
            --config ./original_clash_config.yaml \
            --use-mihomo \
            --mihomo-binary /usr/local/bin/mihomo \
            --max-latency 1000ms \
            --min-download-speed 3 \
            --download-size 5 \
            --upload-size 1 \
            --timeout 60s \
            --max-concurrent 100 \
            --filter "sg|jp|kr|us|ca|de|fr|uk|nl" \
            --block "cn|china|ä¸­å›½|å¤§é™†|åŒ—äº¬|ä¸Šæµ·" \
            --output ./KodeBarinn.yaml \
            --verbose

          if [ ! -f ./KodeBarinn.yaml ] || [ ! -s ./KodeBarinn.yaml ]; then
            echo "â—ï¸ é”™è¯¯: KodeBarinn.yaml æ–‡ä»¶æœªç”Ÿæˆæˆ–ä¸ºç©ºã€‚è¿™æ„å‘³ç€æ²¡æœ‰èŠ‚ç‚¹é€šè¿‡æ‰€æœ‰è®¾å®šçš„æµ‹è¯•å’Œè¿‡æ»¤æ¡ä»¶ã€‚"
            exit 1
          fi
          echo "mihomo-speedtest-rs æµ‹è¯•å’Œè¿‡æ»¤å·²å®Œæˆï¼Œåˆæ ¼èŠ‚ç‚¹å·²ä¿å­˜åˆ° KodeBarinn.yamlã€‚"
          final_node_count=$(grep -c '^- name:' KodeBarinn.yaml || true)
          echo "æœ€ç»ˆç”Ÿæˆäº† ${final_node_count} ä¸ªåˆæ ¼èŠ‚ç‚¹ã€‚"

      - name: â¬†ï¸ ä¸Šä¼ åˆæ ¼çš„ Clash é…ç½®åˆ° Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mihomo-tested-config
          path: KodeBarinn.yaml
          retention-days: 7
          if-no-files-found: ignore
