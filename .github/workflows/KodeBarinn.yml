name: Mihomo SpeedTest

on:
  workflow_dispatch:  # 允许手动触发
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 0:00 运行

jobs:
  speedtest:
    runs-on: ubuntu-latest

    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 设置 Rust 环境
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # 缓存 Rust 依赖
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # 安装 mihomo
      - name: Install mihomo
        run: |
          wget https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64.gz
          gunzip mihomo-linux-amd64.gz
          chmod +x mihomo-linux-amd64
          sudo mv mihomo-linux-amd64 /usr/local/bin/mihomo

      # 安装 mihomo-speedtest-rs
      - name: Install mihomo-speedtest-rs
        run: cargo install mihomo-speedtest-rs --version 1.1.2

      # 运行速度测试
      - name: Run speedtest
        run: |
          mkdir -p sc
          mihomo-speedtest --config https://raw.githubusercontent.com/qjlxg/vt/refs/heads/main/clash_config.yaml \
            --use-mihomo \
            --fast \
            --max-latency 300ms \
            --min-download-speed 10 \
            --download-size 50 \
            --upload-size 20 \
            --output sc/KodeBarinn.yaml

      # 提交结果
      - name: Commit results
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'
          git add sc/KodeBarinn.yaml
          git commit -m 'Update speedtest results' || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
