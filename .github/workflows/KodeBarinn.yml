name: XieCang Speedtest

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours

jobs:
  run-speedtest:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install 'expect' for unbuffer
      run: |
        sudo apt-get update
        sudo apt-get install -y expect
      shell: bash

    - name: Get latest xiecang/speedtest-clash release URL
      id: get_release
      run: |
        ASSET_URL=$(curl -s https://api.github.com/repos/xiecang/speedtest-clash/releases/latest | \
          grep "browser_download_url.*speedtest-clash_Linux_x86_64.tar.gz" | \
          awk '{print $2}' | \
          tr -d '"')
        
        if [ -z "$ASSET_URL" ]; then
          echo "Error: Could not find speedtest-clash_Linux_x86_64.tar.gz in latest release assets."
          exit 1
        fi
        
        echo "::set-output name=download_url::$ASSET_URL"
      shell: bash

    - name: Download and extract xiecang/speedtest-clash
      run: |
        wget ${{ steps.get_release.outputs.download_url }} -O speedtest-clash.tar.gz
        tar -xzf speedtest-clash.tar.gz
        chmod +x speedtest-clash
        ls -l ${{ runner.temp }}/speedtest-clash # Confirm file permissions and existence
      working-directory: ${{ runner.temp }}

    - name: Create output directory
      run: mkdir -p sc

    - name: Run xiecang/speedtest-clash with enhanced logging
      run: |
        echo "Starting xiecang/speedtest-clash..."
        
        unbuffer ${{ runner.temp }}/speedtest-clash \
          -c https://raw.githubusercontent.com/qjlxg/vt/refs/heads/main/clash_config.yaml \
          -output sc/xiecang.yaml \
          -timeout 30s \ # Increased timeout
          -sort b \ # REMOVED: -size parameter
          2>&1 | tee xiecang_output.log
        
        EXIT_CODE=$?
        echo "xiecang/speedtest-clash exited with code: $EXIT_CODE"
        
        echo "--- Full xiecang/speedtest-clash output log ---"
        cat xiecang_output.log
        echo "------------------------------------------------"
        
        if [ -f "sc/xiecang.yaml" ]; then
          echo "sc/xiecang.yaml was successfully generated."
          echo "--- Content of sc/xiecang.yaml (first 20 lines) ---"
          head -n 20 sc/xiecang.yaml
          echo "----------------------------------------------------"
        else
          echo "Error: sc/xiecang.yaml was NOT generated."
          if [ "$EXIT_CODE" -ne 0 ]; then
            echo "xiecang/speedtest-clash failed internally with exit code $EXIT_CODE. This indicates a crash or unhandled error."
            exit "$EXIT_CODE"
          else
            echo "xiecang/speedtest-clash exited with code 0 but did not create the output file. This is unexpected behavior."
            exit 1
          fi
        fi
      shell: bash

    - name: Commit and push results
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add sc/xiecang.yaml
        git commit -m "Update xiecang.yaml with speedtest results" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
