name: OP404OP Clash é€Ÿåº¦æµ‹è¯• (ç‹¬ç«‹)
on:
  workflow_dispatch:
  schedule:
    - cron: '0 0,12 * * *'

jobs:
  op404op-speed-test:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å®‰è£… Python ä¾èµ–
        run: |
          pip install PyYAML

      - name: ä¸‹è½½å®Œæ•´çš„ Clash é…ç½®
        id: download_config
        run: |
          CONFIG_URL="https://raw.githubusercontent.com/qjlxg/vt/refs/heads/main/clash_config.yaml"
          OUTPUT_FILE="clash_config.yaml"
          echo "å°è¯•ä» $CONFIG_URL ä¸‹è½½å®Œæ•´çš„ Clash é…ç½®æ–‡ä»¶..."
          curl -S -L -v --retry 5 --retry-delay 5 --connect-timeout 10 --max-time 60 --output "$OUTPUT_FILE" "$CONFIG_URL"
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯: curl å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œæ— æ³•ä¸‹è½½æ–‡ä»¶ã€‚"
            exit 1
          fi
          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "é”™è¯¯: $OUTPUT_FILE æ–‡ä»¶ä¸å­˜åœ¨ã€‚"
            exit 1
          fi
          if [ ! -s "$OUTPUT_FILE" ]; then
            echo "é”™è¯¯: $OUTPUT_FILE æ–‡ä»¶ä¸ºç©ºã€‚"
            head -n 20 "$OUTPUT_FILE" || true
            exit 1
          fi
          echo "$OUTPUT_FILE æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼Œå¤§å°: $(du -h "$OUTPUT_FILE" | awk '{print $1}')"

      - name: è¿‡æ»¤èŠ‚ç‚¹ (ä½¿ç”¨ Python è„šæœ¬)
        run: python filter_clash_nodes.py
      
      - name: éªŒè¯è¿‡æ»¤åçš„æ–‡ä»¶
        id: check_filtered_file
        run: |
          if [ ! -s "filtered_nodes.yaml" ]; then
            echo "è­¦å‘Š: 'filtered_nodes.yaml' æ–‡ä»¶ä¸ºç©ºæˆ–æ— æœ‰æ•ˆå†…å®¹ã€‚å¯èƒ½æ²¡æœ‰èŠ‚ç‚¹ç¬¦åˆè¿‡æ»¤æ¡ä»¶ã€‚"
            echo "FILTERED_NODES_EMPTY=true" >> $GITHUB_OUTPUT 
            head -n 20 filtered_nodes.yaml || true
            exit 0
          fi
          echo "filtered_nodes.yaml æ–‡ä»¶å¤§å°: $(du -h filtered_nodes.yaml | awk '{print $1}')"
          echo "FILTERED_NODES_EMPTY=false" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½ OP404OP/clash-speedtest å·¥å…·
        id: download_op404op_tool
        run: |
          TOOL_VERSION="v1.6.3"
          TOOL_FILENAME="clash-speedtest-linux-x86_64"
          TOOL_URL="https://github.com/OP404OP/clash-speedtest/releases/download/${TOOL_VERSION}/${TOOL_FILENAME}"
          OUTPUT_PATH="./clash-speedtest-op404op"
          echo "å°è¯•ä» $TOOL_URL ä¸‹è½½ OP404OP/clash-speedtest å·¥å…·..."
          curl -S -L -v --retry 5 --retry-delay 5 --connect-timeout 10 --max-time 60 --output "$OUTPUT_PATH" "$TOOL_URL"
          if [ $? -ne 0 ]; then
            echo "é”™è¯¯: curl å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œæ— æ³•ä¸‹è½½ OP404OP/clash-speedtest å·¥å…·ã€‚è¯·æ£€æŸ¥ TOOL_URL æ˜¯å¦æ­£ç¡®æˆ–ç½‘ç»œé—®é¢˜ã€‚"
            exit 1
          fi
          if [ ! -f "$OUTPUT_PATH" ]; then
            echo "é”™è¯¯: $OUTPUT_PATH æ–‡ä»¶ä¸å­˜åœ¨ã€‚ä¸‹è½½å¯èƒ½æœªæˆåŠŸã€‚"
            exit 1
          fi
          if [ ! -s "$OUTPUT_PATH" ]; then
            echo "é”™è¯¯: $OUTPUT_PATH æ–‡ä»¶ä¸ºç©ºã€‚ä¸‹è½½çš„æ–‡ä»¶å†…å®¹å¯èƒ½ä¸æ­£ç¡®ã€‚"
            head -n 20 "$OUTPUT_PATH" || true
            exit 1
          fi
          echo "OP404OP/clash-speedtest å·¥å…·ä¸‹è½½æˆåŠŸï¼Œå¤§å°: $(du -h "$OUTPUT_PATH" | awk '{print $1}')"
          FILE_TYPE_INFO=$(file "$OUTPUT_PATH")
          echo "æ–‡ä»¶ç±»å‹ä¿¡æ¯: $FILE_TYPE_INFO"
          if ! echo "$FILE_TYPE_INFO" | grep -q "ELF 64-bit LSB executable"; then
              echo "é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯é¢„æœŸçš„ Linux AMD64 å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¯·æ£€æŸ¥ TOOL_URL å’Œ TOOL_FILENAME æ˜¯å¦æ­£ç¡®æŒ‡å‘äº† 'clash-speedtest-linux-x86_64' äºŒè¿›åˆ¶æ–‡ä»¶ã€‚"
              exit 1
          fi
          chmod +x "$OUTPUT_PATH"
          echo "èµ‹äºˆ OP404OP/clash-speedtest æ‰§è¡Œæƒé™å®Œæˆã€‚"
          echo "OP_TOOL_DOWNLOADED=true" >> $GITHUB_OUTPUT

      - name: è¿è¡Œ OP404OP/clash-speedtest è¿›è¡Œé«˜çº§æµ‹è¯•
        if: success() && steps.check_filtered_file.outputs.FILTERED_NODES_EMPTY == 'false' && steps.download_op404op_tool.outputs.OP_TOOL_DOWNLOADED == 'true'
        run: |
          mkdir -p sc
          echo "å¼€å§‹ä½¿ç”¨ OP404OP/clash-speedtest è¿è¡Œé«˜çº§é€Ÿåº¦å’Œè§£é”æµ‹è¯•..."
          # !!! å…³é”®ä¿®æ”¹ï¼šç§»é™¤ -rename å‚æ•° !!!
          ./clash-speedtest-op404op \
            -c ./filtered_nodes.yaml \
            -output sc/OP404OP.yaml \
            -download-size 5 \
            -upload-size 1 \
            -timeout 38s \
            -concurrent 50 \
            -max-latency 5000ms \
            -min-speed 1 \
          #  -unlock \
            -risk
            # -rename ğŸ‘ˆ è¿™ä¸ªå‚æ•°å·²ç»è¢«ç§»é™¤äº†
          echo "OP404OP/clash-speedtest æµ‹è¯•å®Œæˆï¼Œç»“æœä¿å­˜åˆ° sc/OP404OP.yaml"

      - name: éªŒè¯ OP404OP/clash-speedtest ç”Ÿæˆçš„æ–‡ä»¶
        if: success() && steps.download_op404op_tool.outputs.OP_TOOL_DOWNLOADED == 'true'
        run: |
          if [ -f "sc/OP404OP.yaml" ]; then
            echo "'sc/OP404OP.yaml' æ–‡ä»¶å·²ç”Ÿæˆï¼Œå¤§å°: $(du -h sc/OP404OP.yaml | awk '{print $1}')"
            echo "--- sc/OP404OP.yaml æ–‡ä»¶å†…å®¹ (å‰50è¡Œ) ---"
            head -n 50 sc/OP404OP.yaml || true
            echo "----------------------------------------"
            if [ "$(grep -c 'name:' sc/OP404OP.yaml)" -eq 0 ]; then
              echo "è­¦å‘Š: 'sc/OP404OP.yaml' æ–‡ä»¶ä¸­æ²¡æœ‰æ£€æµ‹åˆ°ä»£ç†èŠ‚ç‚¹ã€‚å¯èƒ½æ‰€æœ‰èŠ‚ç‚¹éƒ½æœªé€šè¿‡ OP404OP/clash-speedtest çš„è¿‡æ»¤ã€‚"
            fi
          else
            echo "è­¦å‘Š: æœªç”Ÿæˆ 'sc/OP404OP.yaml'ã€‚OP404OP/clash-speedtest å¯èƒ½å¤±è´¥æˆ–æ²¡æœ‰é€šè¿‡è¿‡æ»¤çš„èŠ‚ç‚¹ã€‚"
          fi

      - name: æäº¤å¹¶æ¨é€ OP404OP é…ç½®æ–‡ä»¶
        if: success() && steps.download_op404op_tool.outputs.OP_TOOL_DOWNLOADED == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "æ›´æ–° OP404OP Clash é…ç½®ï¼šèŠ‚ç‚¹å·²æŒ‰é€Ÿåº¦æ’åºå¹¶åŒ…å«è§£é”ä¿¡æ¯"
          file_pattern: "sc/OP404OP.yaml"
          branch: main
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
          commit_author: qjlxg <12179157+qjlxg@users.noreply.github.com>
          repository: .
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false
          disable_globbing: false
          create_branch: false
          create_git_tag_only: false
          internal_git_binary: git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
